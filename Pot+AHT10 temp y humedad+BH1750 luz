/*
  Prototipo - Cámara Ambiental Inteligente
  Módulo: Sensores
  Microcontrolador: ESP32
*/

#include <Wire.h>
#include <Adafruit_BME280.h>
#include <BH1750.h>
#include <Adafruit_AHTX0.h>

// =====================
// Sensores
// =====================
Adafruit_BME280 bme;
BH1750 lightMeter;
Adafruit_AHTX0 aht;

// Pin del potenciómetro
#define POT_PIN 14

void setup() {
  Serial.begin(115200);
  delay(1000);

  Serial.println("Inicializando sensores...");

  // I2C en ESP32
  Wire.begin(18, 19);  // SDA = 18, SCL = 19

  analogReadResolution(12);  // 0 - 4095

  // =====================
  // Escaneo I2C
  // =====================
  Serial.println("Escaneando I2C...");
  for (byte addr = 1; addr < 127; addr++) {
    Wire.beginTransmission(addr);
    if (Wire.endTransmission() == 0) {
      Serial.print("Dispositivo encontrado en 0x");
      Serial.println(addr, HEX);
    }
  }
  Serial.println("Escaneo completo.\n");

  // =====================
  // BME280
  // =====================
  if (!bme.begin(0x76)) {
    Serial.println("Probando 0x77...");
    if (!bme.begin(0x77)) {
      Serial.println("Error: BME280 no encontrado en ninguna direccion");
    } else {
      Serial.println("BME280 OK en 0x77");
    }
  } else {
    Serial.println("BME280 OK en 0x76");
  }

  // =====================
  // BH1750
  // =====================
  if (lightMeter.begin(BH1750::CONTINUOUS_HIGH_RES_MODE)) {
    Serial.println("BH1750 OK");
  } else {
    Serial.println("Error: BH1750 no encontrado");
  }

  // =====================
  // AHT10
  // =====================
  if (!aht.begin()) {
    Serial.println("Error: AHT10 no encontrado");
  } else {
    Serial.println("AHT10 OK");
  }

  // Test inicial AHT10
  delay(500);
  sensors_event_t aht_hum, aht_temp;
  aht.getEvent(&aht_hum, &aht_temp);
  Serial.print("AHT Test Temp: ");
  Serial.println(aht_temp.temperature);
  Serial.print("AHT Test Hum: ");
  Serial.println(aht_hum.relative_humidity);

  Serial.println("Sistema listo.\n");
}

void loop() {

  Serial.println("------ DATOS ------");

  // =====================
  // BME280
  // =====================
  float temp_bme = bme.readTemperature();
  float hum_bme  = bme.readHumidity();
  float pres_bme = bme.readPressure() / 100.0F;

  Serial.print("BME Temp: ");
  Serial.print(temp_bme);
  Serial.println(" °C");

  Serial.print("BME Humedad: ");
  Serial.print(hum_bme);
  Serial.println(" %");

  Serial.print("BME Presion: ");
  Serial.print(pres_bme);
  Serial.println(" hPa");

  // =====================
  // BH1750
  // =====================
  float lux = lightMeter.readLightLevel();

  Serial.print("BH1750 Luz: ");
  Serial.print(lux);
  Serial.println(" lux");

  // =====================
  // AHT10
  // =====================
  sensors_event_t aht_hum, aht_temp;
  aht.getEvent(&aht_hum, &aht_temp);

  Serial.print("AHT Temp: ");
  Serial.print(aht_temp.temperature);
  Serial.println(" °C");

  Serial.print("AHT Humedad: ");
  Serial.print(aht_hum.relative_humidity);
  Serial.println(" %");

  // =====================
  // Potenciómetro
  // =====================
  int potValue = analogRead(POT_PIN);
  float potPercent = (potValue / 4095.0) * 100.0;

  Serial.print("Potenciometro (ADC): ");
  Serial.println(potValue);

  Serial.print("Potenciometro (%): ");
  Serial.print(potPercent);
  Serial.println(" %");

  Serial.println("-------------------\n");

  delay(2000);
}
